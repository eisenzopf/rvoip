/* ITU G.722 3rd Edition (2012-09) */

/********************************************************************************
*
*      File             : log2.c
*      Purpose          : Computes log2(L_x)
*
********************************************************************************
*/
/*
********************************************************************************
*                         MODULE INCLUDE FILE AND VERSION ID
********************************************************************************
*/
const char log2_id[] = "@(#)$Id $";
 
/*
********************************************************************************
*                         INCLUDE FILES
********************************************************************************
*/
#include "stl.h"
#include "math_op.h"
 
/*
********************************************************************************
*                         LOCAL VARIABLES AND TABLES
********************************************************************************
*/
static const Word32 L_table[32] =
{
        -32768L,   95322112L,  187793408L,  277577728L,
     364871680L,  449740800L,  532381696L,  612859904L,
     691306496L,  767787008L,  842432512L,  915308544L,
     986546176L, 1056210944L, 1124302848L, 1190887424L,
    1256095744L, 1319993344L, 1382580224L, 1443921920L,
    1504083968L, 1563131904L, 1621000192L, 1677885440L,
    1733722112L, 1788510208L, 1842380800L, 1895399424L,
    1947435008L, 1998618624L, 2049015808L, 2098626560L
};
 
static const Word16 table_diff[32] =
{
     1455, 1411,  1370, 1332,  1295, 1261,  1228, 1197,
     1167, 1139,  1112, 1087,  1063, 1039,  1016,  995,
      975,  955,   936,  918,   901,  883,   868,  852,
      836,  822,   809,  794,   781,  769,   757,  744
};
 
/*
********************************************************************************
*                         PUBLIC PROGRAM CODE
********************************************************************************
*/

/*************************************************************************
 *
 *   FUNCTION:   Log2_norm()
 *
 *   PURPOSE:   Computes log2(L_x, exp),  where   L_x is positive and
 *              normalized, and exp is the normalisation exponent
 *              If L_x is negative or zero, the result is 0.
 *
 *   DESCRIPTION:
 *        The function Log2(L_x) is approximated by a table and linear
 *        interpolation. The following steps are used to compute Log2(L_x)
 *
 *           1- exponent = 30-norm_exponent
 *           2- i = bit25-b31 of L_x;  32<=i<=63  (because of normalization).
 *           3- a = bit10-b24
 *           4- i -=32
 *           5- fraction = table[i]<<16 - (table[i] - table[i+1]) * a * 2
 *
 *************************************************************************/
Word16 Log2_norm_lc (   /* (o) : Fractional part of Log2. (range: 0<=val<1)  */
    Word32 L_x          /* (i) : input value (normalized)                    */
)
{
    Word16 i, a;
    Word32 L_y;

    L_x = L_shr (L_x, 9);
    a = extract_l (L_x);                      /* Extract b10-b24 of fraction */
    a = lshr(a, 1);

    i = mac_r(L_x, -32*2-1, 16384);           /* Extract b25-b31 minus 32 */

    L_y = mac_r(L_table[i], table_diff[i], a);/* table[i] << 16 - diff*a*2 */

    return (Word16)L_y;         
}
