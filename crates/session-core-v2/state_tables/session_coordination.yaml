# Session Coordination State Table
# Defines transitions for coordinating between dialog-core and media-core

version: "1.0"

metadata:
  description: "Session coordination state machine for UAC, UAS, and B2BUA roles"
  author: "RVoIP Team"
  date: "2025-09-03"

# Define valid states
states:
  - name: "Idle"
    description: "No active call"
  - name: "Calling"
    description: "UAC initiating outbound call"
  - name: "Ringing"
    description: "UAS received incoming call"
  - name: "Answering"
    description: "UAS accepting call"
  - name: "Active"
    description: "Call established with media flowing"
  - name: "OnHold"
    description: "Call on hold"
  - name: "Terminating"
    description: "Call being terminated"
  - name: "Terminated"
    description: "Call ended"
  - name: "Failed"
    description: "Call failed"

# Define coordination conditions
conditions:
  - name: "MediaReady"
    description: "Media resources are ready"
    default: false
  - name: "DialogEstablished"
    description: "SIP dialog is established"
    default: false

# Define state transitions
transitions:
  # UAC: Make outbound call
  - role: "UAC"
    state: "Idle"
    event:
      type: "MakeCall"
    next_state: "Calling"
    actions:
      - type: "CreateDialog"
      - type: "SetupLocalMedia"
    description: "UAC initiates outbound call"

  # UAC: Call answered
  - role: "UAC"
    state: "Calling"
    event:
      type: "CallAnswered"
    next_state: "Active"
    actions:
      - type: "ProcessAnswer"
      - type: "EstablishMedia"
    conditions:
      set:
        - "MediaReady"
        - "DialogEstablished"
    description: "UAC receives answer"

  # UAC: Call rejected
  - role: "UAC"
    state: "Calling"
    event:
      type: "CallRejected"
    next_state: "Failed"
    actions:
      - type: "ProcessRejection"
    description: "UAC call rejected"

  # UAC: Timeout
  - role: "UAC"
    state: "Calling"
    event:
      type: "Timeout"
    next_state: "Terminated"
    actions:
      - type: "CancelCall"
    description: "UAC call timeout"

  # UAC: Hangup active call
  - role: "UAC"
    state: "Active"
    event:
      type: "HangupCall"
    next_state: "Terminating"
    actions:
      - type: "InitiateTermination"
    description: "UAC hangs up"

  # UAC: Hold call
  - role: "UAC"
    state: "Active"
    event:
      type: "HoldCall"
    next_state: "OnHold"
    actions:
      - type: "SendReinviteHold"
    description: "UAC puts call on hold"

  # UAC: Resume call
  - role: "UAC"
    state: "OnHold"
    event:
      type: "ResumeCall"
    next_state: "Active"
    actions:
      - type: "SendReinviteResume"
    description: "UAC resumes call"

  # UAC: Termination complete
  - role: "UAC"
    state: "Terminating"
    event:
      type: "TerminationComplete"
    next_state: "Terminated"
    actions:
      - type: "CleanupResources"
    description: "UAC termination complete"

  # UAC: Hangup from Idle (no-op case)
  - role: "UAC"
    state: "Idle"
    event:
      type: "HangupCall"
    next_state: "Idle"
    actions: []
    description: "UAC hangup when idle (no-op)"

  # UAS: Incoming call
  - role: "UAS"
    state: "Idle"
    event:
      type: "IncomingCall"
    next_state: "Ringing"
    actions:
      - type: "CreateDialog"
      - type: "ProcessInvite"
    description: "UAS receives incoming call"

  # UAS: Accept call
  - role: "UAS"
    state: "Ringing"
    event:
      type: "AcceptCall"
    next_state: "Answering"
    actions:
      - type: "SetupLocalMedia"
      - type: "PrepareAnswer"
    description: "UAS accepts call"

  # UAS: Media ready
  - role: "UAS"
    state: "Answering"
    event:
      type: "MediaReady"
    next_state: "Active"
    actions:
      - type: "Send200OK"
      - type: "EstablishMedia"
    conditions:
      set:
        - "MediaReady"
        - "DialogEstablished"
    description: "UAS media ready"

  # UAS: Reject call
  - role: "UAS"
    state: "Ringing"
    event:
      type: "RejectCall"
    next_state: "Terminated"
    actions:
      - type: "SendRejectResponse"
    description: "UAS rejects call"

  # UAS: Hangup active call
  - role: "UAS"
    state: "Active"
    event:
      type: "HangupCall"
    next_state: "Terminating"
    actions:
      - type: "InitiateTermination"
    description: "UAS hangs up"

  # UAS: Remote hangup
  - role: "UAS"
    state: "Active"
    event:
      type: "RemoteHangup"
    next_state: "Terminating"
    actions:
      - type: "ProcessBye"
      - type: "Send200OK"
    description: "UAS receives remote hangup"

  # UAS: Hold call
  - role: "UAS"
    state: "Active"
    event:
      type: "HoldCall"
    next_state: "OnHold"
    actions:
      - type: "SendReinviteHold"
    description: "UAS puts call on hold"

  # UAS: Resume call
  - role: "UAS"
    state: "OnHold"
    event:
      type: "ResumeCall"
    next_state: "Active"
    actions:
      - type: "SendReinviteResume"
    description: "UAS resumes call"

  # UAS: Termination complete
  - role: "UAS"
    state: "Terminating"
    event:
      type: "TerminationComplete"
    next_state: "Terminated"
    actions:
      - type: "CleanupResources"
    description: "UAS termination complete"

  # Common: Error handling
  - role: "Both"
    state: "*"
    event:
      type: "Error"
    next_state: "Failed"
    actions:
      - type: "HandleError"
    description: "Handle error condition"

  # Common: Reset from failed
  - role: "Both"
    state: "Failed"
    event:
      type: "Reset"
    next_state: "Idle"
    actions:
      - type: "ResetSession"
    description: "Reset from failed state"

  # Common: Reset from terminated
  - role: "Both"
    state: "Terminated"
    event:
      type: "Reset"
    next_state: "Idle"
    actions:
      - type: "ResetSession"
    description: "Reset from terminated state"