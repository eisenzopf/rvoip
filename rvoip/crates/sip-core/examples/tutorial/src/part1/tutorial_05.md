# SIP Responses in Depth

In this tutorial, we'll explore SIP responses - the messages sent by servers and user agents in reply to SIP requests. Building on what we've learned about the builder pattern, we'll look at the structure, categories, and common types of SIP responses, and implement them using the `rvoip-sip-core` library.

## SIP Response Structure

A SIP response consists of:

1. **Status Line**: Contains the SIP version, status code, and a reason phrase
2. **Headers**: Various headers providing information about the response
3. **Message Body** (optional): Contains additional data like SDP for media negotiation

The status line format is:
```
SIP/2.0 [Status Code] [Reason Phrase]
```

For example:
```
SIP/2.0 200 OK
```

## Response Categories

SIP responses are grouped into six categories based on their status codes:

| Category | Range | Description |
|----------|-------|-------------|
| Provisional | 1xx | Request received and being processed |
| Success | 2xx | Request was successfully received, understood, and accepted |
| Redirection | 3xx | Further action needs to be taken to complete the request |
| Client Error | 4xx | The request contains bad syntax or cannot be fulfilled at this server |
| Server Error | 5xx | The server failed to fulfill a valid request |
| Global Failure | 6xx | The request cannot be fulfilled at any server |

Let's examine each category and how to create responses using the `ResponseBuilder` in `rvoip-sip-core`.

## 1xx - Provisional Responses

Provisional responses indicate that a request has been received and is being processed, but no final determination has been made. Common 1xx responses include:

- **100 Trying**: The request has been received and is being processed
- **180 Ringing**: The destination user agent has received the INVITE and is alerting the user
- **183 Session Progress**: Used to convey information about the progress of the call that's not otherwise classified

### 100 Trying Response

The 100 Trying response is typically sent by a proxy server to indicate that it has received the request and is working on routing it. It stops retransmissions of the request and is not forwarded to other servers.

```rust
let response = ResponseBuilder::new(StatusCode::Trying, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .build();
```

Note that a 100 Trying response doesn't include a Contact header, as it's typically generated by intermediaries.

### 180 Ringing Response

The 180 Ringing response indicates that the destination user agent has received the INVITE and is alerting the user (e.g., playing a ringtone).

```rust
let response = ResponseBuilder::new(StatusCode::Ringing, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .contact("sip:bob@biloxi.example.com", None)
    .build();
```

### 183 Session Progress with Early Media

The 183 Session Progress response is often used to send early media (like ringback tones or announcements) before the call is answered. It typically includes an SDP body.

```rust
// Create SDP for early media
let sdp = SdpBuilder::new("Session Progress")
    .origin("bob", "2890844527", "2890844527", "IN", "IP4", "biloxi.example.com")
    .connection("IN", "IP4", "biloxi.example.com") 
    .time("0", "0")
    .media_audio(49172, "RTP/AVP")
        .formats(&["0"])
        .rtpmap("0", "PCMU/8000")
        .direction(MediaDirection::SendOnly) // One-way early media
        .done()
    .build()?;

let require = Require::with_tag("100rel");

let response = ResponseBuilder::new(StatusCode::SessionProgress, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .contact("sip:bob@biloxi.example.com", None)
    .content_type("application/sdp")
    .header(TypedHeader::Require(require)) // Requires reliable provisional responses
    .header(TypedHeader::Other(HeaderName::Other("RSeq".to_string()), HeaderValue::Raw(b"1".to_vec()))) // RSeq header for reliability
    .body(sdp.to_string())
    .build();
```

The `100rel` extension (RFC 3262) provides reliability for provisional responses, which is important when they contain SDP. The RSeq header is used in conjunction with PRACK requests to confirm receipt of reliable provisional responses.

## 2xx - Success Responses

Success responses indicate that a request was successfully received, understood, and accepted. The most common 2xx response is 200 OK.

### 200 OK Response to INVITE

A 200 OK response to an INVITE includes an SDP answer and establishes a session.

```rust
// Create SDP answer
let sdp = SdpBuilder::new("Call with Alice")
    .origin("bob", "2890844527", "2890844527", "IN", "IP4", "biloxi.example.com")
    .connection("IN", "IP4", "biloxi.example.com") 
    .time("0", "0")
    .media_audio(49172, "RTP/AVP")
        .formats(&["0"])
        .rtpmap("0", "PCMU/8000")
        .direction(MediaDirection::SendRecv)
        .done()
    .build()?;

let response = ResponseBuilder::new(StatusCode::Ok, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .contact("sip:bob@biloxi.example.com", None)
    .content_type("application/sdp")
    .allow_methods(vec![
        Method::Invite,
        Method::Ack,
        Method::Cancel,
        Method::Bye,
        Method::Refer,
        Method::Notify,
        Method::Options
    ])
    .supported_tags(vec![
        "replaces".to_string(),
        "100rel".to_string()
    ])
    .session_expires(3600, Some(Refresher::Uas))
    .body(sdp.to_string())
    .build();
```

Important headers for 200 OK responses to INVITE:

- **Contact**: Where subsequent requests in the dialog should be sent
- **Allow**: Lists methods supported by the UA
- **Supported**: Lists SIP extensions supported by the UA
- **Session-Expires**: Session refresh interval and refresher role

### 202 Accepted Response

The 202 Accepted response is typically used for asynchronous operations like SUBSCRIBE requests.

```rust
let response = ResponseBuilder::new(StatusCode::Accepted, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("7a9f2f899ndf98f7a8fd9f890as87f9a")
    .cseq(1, Method::Subscribe)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .contact("sip:bob@biloxi.example.com", None)
    .expires_seconds(3600) // How long the subscription is accepted for
    .build();
```

For SUBSCRIBE requests, the Expires header indicates how long the subscription is valid.

## 3xx - Redirection Responses

Redirection responses indicate that further action needs to be taken to complete the request. They typically contain a Contact header with an alternative address.

### 302 Moved Temporarily Response

The 302 Moved Temporarily response indicates that the user is temporarily available at a different address.

```rust
let response = ResponseBuilder::new(StatusCode::MovedTemporarily, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .contact("sip:bob@chicago.example.com", None) // New contact address
    .expires_seconds(1800) // For how long this redirection is valid
    .build();
```

The Contact header in a redirection response contains the new address where the request should be directed. The Expires header (if present) indicates how long the redirection is valid.

### 305 Use Proxy Response

The 305 Use Proxy response indicates that the request should be sent through a specific proxy.

```rust
let response = ResponseBuilder::new(StatusCode::UseProxy, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .contact("sip:proxy.biloxi.example.com", None) // Proxy address
    .build();
```

## 4xx - Client Error Responses

Client error responses indicate that the request contains bad syntax or cannot be fulfilled at the server. The client should modify the request before retrying.

### 400 Bad Request Response

The 400 Bad Request response indicates that the request was malformed or contained an invalid parameter.

```rust
let response = ResponseBuilder::new(StatusCode::BadRequest, Some("Missing Required Header"))
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .build();
```

Note the optional reason phrase parameter in the constructor, which allows you to provide a specific reason for the error.

### 401 Unauthorized Response

The 401 Unauthorized response indicates that authentication credentials are required. It includes a WWW-Authenticate header with challenge information.

```rust
let response = ResponseBuilder::new(StatusCode::Unauthorized, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .www_authenticate_digest(
        "biloxi.example.com",                  // realm
        "dcd98b7102dd2f0e8b11d0f600bfb0c093",  // nonce
        Some("auth"),                          // qop
        Some("MD5"),                           // algorithm
        Some(vec!["5ccc069c403ebaf9f0171e9517f40e41"]), // opaque
        None,                                  // stale
        None                                   // domain
    )
    .build();
```

The WWW-Authenticate header provides parameters for the client to use in formulating an authentication response.

### 403 Forbidden Response

The 403 Forbidden response indicates that the server understood the request but refuses to fulfill it.

```rust
let response = ResponseBuilder::new(StatusCode::Forbidden, Some("User blocked"))
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .build();
```

### 404 Not Found Response

The 404 Not Found response indicates that the server has definitive information that the user does not exist at the domain specified in the Request-URI.

```rust
let response = ResponseBuilder::new(StatusCode::NotFound, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .build();
```

### 406 Not Acceptable Response

The 406 Not Acceptable response indicates that the server cannot generate a response that matches the Accept header criteria in the request.

```rust
let response = ResponseBuilder::new(StatusCode::NotAcceptable, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .accept("application/sdp", None) // Only accept SDP
    .build();
```

### 486 Busy Here Response

The 486 Busy Here response indicates that the user is currently busy and cannot take the call.

```rust
// Create RetryAfter header using the RetryAfter::new() constructor
let retry_after = RetryAfter::new(60)
    .with_comment("User in another call");

let response = ResponseBuilder::new(StatusCode::BusyHere, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .header(TypedHeader::RetryAfter(retry_after)) // Try again in 1 minute
    .build();
```

The Retry-After header suggests when the client should try the request again.

## 5xx - Server Error Responses

Server error responses indicate that the server failed to fulfill an apparently valid request.

### 500 Server Internal Error Response

The 500 Server Internal Error response indicates that the server encountered an unexpected condition that prevented it from fulfilling the request.

```rust
// Create RetryAfter header using the RetryAfter::new() constructor
let retry_after = RetryAfter::new(300)
    .with_comment("Server maintenance")
    .with_param(Param::new("reason", Some("maintenance")));

let response = ResponseBuilder::new(StatusCode::ServerInternalError, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .header(TypedHeader::RetryAfter(retry_after)) // Retry after 5 minutes with alternate retry intervals
    .build();
```

### 503 Service Unavailable Response

The 503 Service Unavailable response indicates that the server is temporarily unable to handle the request due to overload or maintenance.

```rust
// Create RetryAfter header using the RetryAfter::new() constructor
let retry_after = RetryAfter::new(120);

let response = ResponseBuilder::new(StatusCode::ServiceUnavailable, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .header(TypedHeader::RetryAfter(retry_after)) // Retry after 2 minutes
    .build();
```

## 6xx - Global Failure Responses

Global failure responses indicate that the request cannot be fulfilled at any server.

### 603 Decline Response

The 603 Decline response indicates that the user explicitly does not wish to participate in the call.

```rust
// Create RetryAfter header using the RetryAfter::new() constructor
let retry_after = RetryAfter::new(3600)
    .with_comment("User unavailable");

let response = ResponseBuilder::new(StatusCode::Decline, None)
    .from("Bob", "sip:bob@biloxi.example.com", None)
    .to("Alice", "sip:alice@atlanta.example.com", Some("9fxced76sl"))
    .call_id("3848276298220188511@atlanta.example.com")
    .cseq(314159, Method::Invite)
    .via("atlanta.example.com:5060", "UDP", Some("z9hG4bKnashds7"))
    .header(TypedHeader::RetryAfter(retry_after)) // Try again in 1 hour
    .build();
```

## Common Response Headers

All SIP responses share a common set of headers:

1. **From**: Identifies the initiator of the request
2. **To**: Identifies the intended recipient of the request
3. **Call-ID**: Unique identifier for the call
4. **CSeq**: Command sequence number and method
5. **Via**: Indicates the path taken by the request

Additional common headers include:

6. **Contact**: Where subsequent requests should be sent
7. **Content-Type**: Format of the message body
8. **Content-Length**: Size of the message body in bytes
9. **Server**: Information about the server software

## Creating Responses from Requests

In real-world applications, responses are often created based on incoming requests. The `ResponseBuilder` provides convenience methods to create responses directly from requests:

```rust
let incoming_request = /* ... */;

// Create a 200 OK response
let ok_response = ResponseBuilder::response_from_request(incoming_request, StatusCode::Ok, None)
    .contact("sip:bob@biloxi.example.com", None)
    .build();

// Create a 404 Not Found response
let not_found = ResponseBuilder::response_from_request(incoming_request, StatusCode::NotFound, None)
    .build();
```

This approach ensures that all necessary headers from the request are properly reflected in the response.

## Response Processing

When processing a response, a client should:

1. Examine the status code to determine the outcome of the request
2. For 3xx responses, extract the Contact header to determine the new target
3. For 401/407 responses, extract authentication details to formulate a new request
4. For 2xx responses to INVITE, extract the SDP to establish the media session

## Conclusion

SIP responses are the other half of the request-response protocol model. Understanding how to generate and interpret different types of responses is essential for implementing SIP applications.

In the next tutorial, we'll move on to explore Session Description Protocol (SDP), which is a key component in establishing media sessions through SIP.

## Exercises

1. Create a 180 Ringing response with a require header specifying "100rel" for reliable provisional responses.
2. Create a 407 Proxy Authentication Required response with appropriate challenge headers.
3. Create a 302 Moved Temporarily response with multiple Contact headers for load balancing.
4. Create a 420 Bad Extension response that indicates which extensions were not understood.
5. Create a 200 OK response to an OPTIONS request that includes comprehensive capability information. 