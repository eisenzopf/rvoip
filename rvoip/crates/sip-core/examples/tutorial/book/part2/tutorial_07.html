<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Creating SDP Messages</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="creating-sdp-messages"><a class="header" href="#creating-sdp-messages">Creating SDP Messages</a></h1>
<p>In the previous tutorial, we introduced SDP and its structure. Now, we'll dive deeper into creating more complex SDP messages using the <code>rvoip-sip-core</code> library's builder pattern.</p>
<h2 id="advanced-sdp-creation"><a class="header" href="#advanced-sdp-creation">Advanced SDP Creation</a></h2>
<p>The SdpBuilder API provides a fluent interface for creating SDP messages of varying complexity. In this tutorial, we'll explore:</p>
<ol>
<li>Creating sophisticated multi-stream SDP messages</li>
<li>Setting up codec-specific parameters</li>
<li>Working with bandwidth and quality of service (QoS) parameters</li>
<li>Advanced attributes for WebRTC applications</li>
<li>Creating SDP answers based on offers</li>
</ol>
<h2 id="building-multi-stream-sessions"><a class="header" href="#building-multi-stream-sessions">Building Multi-Stream Sessions</a></h2>
<p>Real-world SIP applications often need to establish sessions with multiple media streams, each with different characteristics. Let's look at how to create an SDP with multiple audio and video streams:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let sdp = SdpBuilder::new("Multi-Stream Session")
    .origin("alice", "2890844526", "2890844526", "IN", "IP4", "alice.example.com")
    .connection("IN", "IP4", "alice.example.com")
    .time("0", "0")
    // Primary audio stream (high quality)
    .media_audio(49170, "RTP/AVP")
        .formats(&amp;["109", "0", "8"])
        .rtpmap("109", "opus/48000/2")
        .rtpmap("0", "PCMU/8000")
        .rtpmap("8", "PCMA/8000")
        .fmtp("109", "maxplaybackrate=48000;stereo=1;maxaveragebitrate=256000")
        .ptime(20)
        .direction(MediaDirection::SendRecv)
        .done()
    // Secondary audio stream (backup narrowband)
    .media_audio(49172, "RTP/AVP")
        .formats(&amp;["0"])
        .rtpmap("0", "PCMU/8000")
        .direction(MediaDirection::SendRecv)
        .done()
    // Main video stream (HD)
    .media_video(49174, "RTP/AVP")
        .formats(&amp;["97", "98"])
        .rtpmap("97", "H264/90000")
        .rtpmap("98", "VP8/90000")
        .fmtp("97", "profile-level-id=42e01f;packetization-mode=1")
        .direction(MediaDirection::SendRecv)
        .done()
    // Secondary video stream (SD)
    .media_video(49176, "RTP/AVP")
        .formats(&amp;["97"])
        .rtpmap("97", "H264/90000")
        .fmtp("97", "profile-level-id=42e00c;packetization-mode=1")
        .direction(MediaDirection::SendRecv)
        .done()
    .build()?;
<span class="boring">}</span></code></pre></pre>
<p>This example creates an SDP with four media streams: two audio and two video. Each has different characteristics:</p>
<ul>
<li>The primary audio stream offers Opus (high quality) with G.711 fallback</li>
<li>The secondary audio stream only offers G.711 μ-law</li>
<li>The main video stream offers both H.264 and VP8 in HD</li>
<li>The secondary video stream offers H.264 in SD quality</li>
</ul>
<h2 id="working-with-codec-parameters"><a class="header" href="#working-with-codec-parameters">Working with Codec Parameters</a></h2>
<p>The format parameters (fmtp) attribute allows for detailed configuration of codecs. Each codec has its own specific parameters:</p>
<h3 id="opus-audio-parameters"><a class="header" href="#opus-audio-parameters">Opus Audio Parameters</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>.fmtp("109", "maxplaybackrate=48000;stereo=1;maxaveragebitrate=256000")
<span class="boring">}</span></code></pre></pre>
<p>These parameters configure:</p>
<ul>
<li>Maximum playback rate (48kHz)</li>
<li>Stereo audio (2 channels)</li>
<li>Maximum bitrate (256 kbps)</li>
</ul>
<h3 id="h264-video-parameters"><a class="header" href="#h264-video-parameters">H.264 Video Parameters</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>.fmtp("97", "profile-level-id=42e01f;packetization-mode=1")
<span class="boring">}</span></code></pre></pre>
<p>These parameters specify:</p>
<ul>
<li>Profile level ID (Baseline Profile, Level 3.1)</li>
<li>Packetization mode (1 = Non-Interleaved Mode)</li>
</ul>
<h3 id="vp8-video-parameters"><a class="header" href="#vp8-video-parameters">VP8 Video Parameters</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>.fmtp("98", "max-fr=30;max-fs=8160")
<span class="boring">}</span></code></pre></pre>
<p>These parameters set:</p>
<ul>
<li>Maximum frame rate (30 fps)</li>
<li>Maximum frame size (8160 macroblocks, roughly 720p)</li>
</ul>
<h2 id="bandwidth-and-qos-parameters"><a class="header" href="#bandwidth-and-qos-parameters">Bandwidth and QoS Parameters</a></h2>
<p>SDP allows you to specify bandwidth constraints for the session or individual media streams:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let sdp = SdpBuilder::new("Session with Bandwidth")
    .origin("alice", "2890844526", "2890844526", "IN", "IP4", "alice.example.com")
    .connection("IN", "IP4", "alice.example.com")
    .time("0", "0")
    // Session-level bandwidth constraint
    .bandwidth("AS", 1024)  // 1024 kbps total bandwidth
    .media_audio(49170, "RTP/AVP")
        .formats(&amp;["109"])
        .rtpmap("109", "opus/48000/2")
        // Media-level bandwidth constraint
        .bandwidth("TIAS", 128000)  // 128 kbps for audio (Transport Independent Application Specific)
        .done()
    .media_video(49172, "RTP/AVP")
        .formats(&amp;["97"])
        .rtpmap("97", "H264/90000")
        // Media-level bandwidth constraint
        .bandwidth("AS", 896)  // 896 kbps for video (Application Specific)
        .bandwidth("TIAS", 896000)  // Same in Transport Independent Application Specific units
        .done()
    .build()?;
<span class="boring">}</span></code></pre></pre>
<p>Different bandwidth specifiers serve different purposes:</p>
<ul>
<li><strong>AS</strong>: Application Specific - overall bandwidth for all media components</li>
<li><strong>CT</strong>: Conference Total - bandwidth shared by all conference participants</li>
<li><strong>TIAS</strong>: Transport Independent Application Specific - most precise way to specify bandwidth</li>
</ul>
<h2 id="webrtc-specific-sdp-features"><a class="header" href="#webrtc-specific-sdp-features">WebRTC-Specific SDP Features</a></h2>
<p>WebRTC uses SDP for session negotiation but requires additional attributes for features like ICE, DTLS, and RTCP feedback:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let sdp = SdpBuilder::new("WebRTC Session")
    .origin("webrtc", "2890844527", "1", "IN", "IP4", "0.0.0.0")
    .connection("IN", "IP4", "0.0.0.0")
    .time("0", "0")
    // Session-level WebRTC attributes
    .group("BUNDLE", &amp;["audio", "video"])  // Bundle audio and video on same transport
    .ice_ufrag("8hhY")
    .ice_pwd("asd88fgpdd777uzjYhagZg")
    .fingerprint("sha-256", "39:4A:09:1E:0E:27:00:19:5D:30:9A:34:3C:1A:EB:69:43:33:51:35:AE:8F:EC:56:4C:35:6A:A7:41:3A:14:3C")
    .media_audio(9, "UDP/TLS/RTP/SAVPF")
        .formats(&amp;["111", "103"])
        .rtpmap("111", "opus/48000/2")
        .rtpmap("103", "ISAC/16000")
        .fmtp("111", "minptime=10;useinbandfec=1")
        .mid("audio")
        .rtcp_mux()  // Multiplex RTP and RTCP on same port
        .rtcp_fb("111", "nack", None::&lt;String&gt;)  // NACK feedback for Opus
        .direction(MediaDirection::SendRecv)
        .setup("actpass")  // DTLS role
        .ice_ufrag("8hhY")
        .ice_pwd("asd88fgpdd777uzjYhagZg")
        .ice_candidate("1 1 UDP 2113937151 192.168.1.100 9 typ host")
        .extmap(1, None::&lt;String&gt;, "urn:ietf:params:rtp-hdrext:ssrc-audio-level", None::&lt;String&gt;)
        .done()
    .media_video(9, "UDP/TLS/RTP/SAVPF")
        .formats(&amp;["96", "97"])
        .rtpmap("96", "VP8/90000")
        .rtpmap("97", "rtx/90000")
        .fmtp("97", "apt=96")  // RTX repair format for VP8
        .mid("video")
        .rtcp_mux()
        .rtcp_fb("96", "nack", None::&lt;String&gt;)  // Negative acknowledgment for VP8
        .rtcp_fb("96", "nack", Some("pli"))  // Picture loss indication for VP8
        .rtcp_fb("96", "ccm", Some("fir"))  // Full intra request for VP8
        .direction(MediaDirection::SendRecv)
        .setup("actpass")
        .ice_ufrag("8hhY")
        .ice_pwd("asd88fgpdd777uzjYhagZg")
        .ice_candidate("1 1 UDP 2113937151 192.168.1.100 9 typ host")
        .extmap(2, None::&lt;String&gt;, "urn:ietf:params:rtp-hdrext:toffset", None::&lt;String&gt;)
        .done()
    .build()?;
<span class="boring">}</span></code></pre></pre>
<p>Key WebRTC features include:</p>
<ul>
<li><strong>ICE candidates</strong> for NAT traversal</li>
<li><strong>DTLS fingerprints</strong> for secure key exchange</li>
<li><strong>RTCP feedback mechanisms</strong> for congestion control and stream quality</li>
<li><strong>RTP header extensions</strong> for additional metadata</li>
<li><strong>Bundling</strong> for efficient use of network resources</li>
</ul>
<h2 id="working-with-simulcast-and-svc"><a class="header" href="#working-with-simulcast-and-svc">Working with Simulcast and SVC</a></h2>
<p>For applications requiring scalable video, SDP can describe simulcast or scalable video coding (SVC):</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let sdp = SdpBuilder::new("Simulcast Session")
    .origin("alice", "2890844526", "2890844526", "IN", "IP4", "alice.example.com")
    .connection("IN", "IP4", "alice.example.com")
    .time("0", "0")
    .media_video(49174, "RTP/AVP")
        .formats(&amp;["96", "97", "98"])
        .rtpmap("96", "VP8/90000")
        .rtpmap("97", "VP8/90000")
        .rtpmap("98", "VP8/90000")
        // RID (Restriction Identifiers) for simulcast streams
        .rid("high", rvoip_sip_core::sdp::attributes::rid::RidDirection::Send, &amp;["96"], &amp;[("max-width", "1280"), ("max-height", "720")])
        .rid("medium", rvoip_sip_core::sdp::attributes::rid::RidDirection::Send, &amp;["97"], &amp;[("max-width", "640"), ("max-height", "360")])
        .rid("low", rvoip_sip_core::sdp::attributes::rid::RidDirection::Send, &amp;["98"], &amp;[("max-width", "320"), ("max-height", "180")])
        // Simulcast description
        .simulcast(vec!["high;medium;low".to_string()], Vec::&lt;String&gt;::new())
        .direction(MediaDirection::SendRecv)
        .done()
    .build()?;
<span class="boring">}</span></code></pre></pre>
<p>This example creates an SDP that offers three simulcast streams (high, medium, and low resolution) of VP8 video.</p>
<h2 id="creating-sdp-answers"><a class="header" href="#creating-sdp-answers">Creating SDP Answers</a></h2>
<p>When responding to an SDP offer, you need to create an SDP answer that selects from the offered capabilities:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Assuming we received an offer SDP
let offer = received_sdp;

// Create an answer based on the offer
let answer = offer.into_builder()
    // Update origin with our information
    .origin("bob", "9876543210", "1", "IN", "IP4", "bob.example.com")
    // Update connection with our address
    .connection("IN", "IP4", "bob.example.com")
    // Keep the offered media streams but potentially modify them
    .media_audio(49170, "RTP/AVP")
        // Choose only one of the offered codecs
        .formats(&amp;["0"])
        .rtpmap("0", "PCMU/8000")
        .direction(MediaDirection::SendRecv)
        .done()
    .media_video(49172, "RTP/AVP")
        // Choose only H.264 from the offered codecs
        .formats(&amp;["97"])
        .rtpmap("97", "H264/90000")
        .fmtp("97", "profile-level-id=42e01f;packetization-mode=1")
        .direction(MediaDirection::SendRecv)
        .done()
    .build()?;
<span class="boring">}</span></code></pre></pre>
<p>When creating an answer, it's important to:</p>
<ol>
<li>Only include media types that were in the offer</li>
<li>Only select codecs that were offered</li>
<li>Ensure compatibility of parameters</li>
<li>Set appropriate connection information</li>
<li>Match the offered session structure</li>
</ol>
<h2 id="sdp-validation-and-error-handling"><a class="header" href="#sdp-validation-and-error-handling">SDP Validation and Error Handling</a></h2>
<p>The <code>build()</code> method on SdpBuilder performs validation before returning the SdpSession:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>match sdp_builder.build() {
    Ok(sdp) =&gt; {
        println!("Valid SDP created:");
        println!("{}", sdp);
    },
    Err(e) =&gt; {
        println!("Failed to create valid SDP: {}", e);
        // Handle the error - perhaps fix the issues in the builder
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Common validation failures include:</p>
<ul>
<li>Missing required fields (like origin, session name, time description)</li>
<li>Invalid connection information</li>
<li>Media sections without formats</li>
<li>ICE candidates with invalid IP addresses</li>
<li>Inconsistent media formats and rtpmap entries</li>
</ul>
<h2 id="best-practices-for-creating-sdp"><a class="header" href="#best-practices-for-creating-sdp">Best Practices for Creating SDP</a></h2>
<ol>
<li><strong>Always include required fields</strong>: v=, o=, s=, t=, and either session-level or media-level c=</li>
<li><strong>Use specific format identifiers</strong>: Prefer specific dynamic payload types for each codec</li>
<li><strong>Include rtpmap for all dynamic payload types</strong>: Always map payload types &gt;95 with rtpmap</li>
<li><strong>Set appropriate directions</strong>: Be explicit about the media direction (sendrecv, sendonly, recvonly, inactive)</li>
<li><strong>Reuse session-level attributes</strong>: When attributes apply to all media sections, define them at session level</li>
<li><strong>Be consistent with transport</strong>: Ensure protocol compatibility across the entire session</li>
<li><strong>Handle time properly</strong>: Use "0 0" for persistent sessions</li>
<li><strong>Validate before sending</strong>: Always call <code>build()</code> to verify the SDP is valid</li>
</ol>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>Creating effective SDP messages is crucial for establishing compatible and efficient media sessions. The <code>rvoip-sip-core</code> SdpBuilder provides a robust API for creating SDP messages of varying complexity, from simple audio calls to sophisticated WebRTC applications with multiple streams, simulcast, and advanced media features.</p>
<p>In the next tutorial, we'll explore how to integrate SDP with SIP messages to establish complete multimedia sessions.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../part2/tutorial_06.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../part2/tutorial_08.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../part2/tutorial_06.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../part2/tutorial_08.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
