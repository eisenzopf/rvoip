# Session Core - TODO List

This document tracks planned improvements and enhancements for the `rvoip-session-core` library.

## âœ… COMPLETED - Core Infrastructure Foundation

### Session Manager & Dialog Integration
- [x] SessionManager with async event processing
- [x] Session creation and lifecycle management  
- [x] Integration with transaction-core and dialog management
- [x] Event-driven architecture with EventBus
- [x] Session-to-dialog mapping and coordination
- [x] DialogManager integration within SessionManager
- [x] Dialog-to-session association and mapping
- [x] Dialog lifecycle coordination with session states
- [x] Event propagation between dialogs and sessions
- [x] Dialog recovery mechanisms

### SDP Negotiation & Media Coordination
- [x] SdpContext integration in Dialog management
- [x] SDP offer/answer state machine (Initial, OfferSent, OfferReceived, Complete)
- [x] SDP generation for outgoing calls (create_audio_offer)
- [x] SDP answer generation for incoming calls (create_audio_answer)
- [x] SDP renegotiation support for re-INVITEs
- [x] Media configuration extraction (extract_media_config)
- [x] Hold/resume operations (put_call_on_hold, resume_held_call)
- [x] SDP direction handling (sendrecv, sendonly, recvonly, inactive)

### Transaction Layer Integration
- [x] Transaction event subscription in SessionManager
- [x] Transaction event processing loop for session management
- [x] Transaction-to-dialog mapping for proper event routing
- [x] Transaction state timeouts and error handling
- [x] Transaction cancellation for INVITE requests
- [x] Forked INVITE transaction handling
- [x] Transaction termination cleanup
- [x] Retransmission handling coordination with transaction layer
- [x] ACK handling for non-2xx responses (auto-generated by transaction layer)
- [x] Transaction timer events handling (Timer A-K)
- [x] Transaction state synchronization with session/dialog states

### Request Generation and Processing
- [x] Request generation for all SIP methods
- [x] Proper header generation (Via, Contact, CSeq, etc.)
- [x] Incoming request handling via transactions
- [x] Response creation and sending through transactions
- [x] ACK handling for INVITE transactions
- [x] ACK for 2xx responses (TU responsibility)
- [x] Response handling for different transaction types

### Error Handling & Robustness
- [x] Detailed error types with specific categorization (network, protocol, application)
- [x] Retry mechanisms for recoverable errors
- [x] Error propagation with context through the stack
- [x] Graceful fallback for non-critical failures
- [x] Timeout handling for all operations
- [x] Boundary checking for user inputs

### Early Dialog Management
- [x] Support for multiple simultaneous early dialogs
- [x] Forking scenario handling per RFC 3261 Section 12.1.2

### Async Runtime Optimizations
- [x] Event-driven mechanisms replacing polling-based subscription tracking
- [x] Efficient task management for event handling
- [x] DashMap for concurrent access to transaction subscriptions
- [x] Proper backpressure handling in event channels
- [x] tokio::select! for efficient multiplexing of event sources
- [x] Reduced number of spawned tasks by consolidating related functionality
- [x] Channel buffer size tuning based on expected transaction volume
- [x] Dead task cleanup for orphaned subscriptions
- [x] Benchmarks for async runtime performance
- [x] Lock contention fixes in high-volume scenarios

### Public API & Helper Functions
- [x] High-level client API for common call scenarios
- [x] Server API for registration, proxy, and B2BUA use cases
- [x] Session modification API (hold, resume, transfer)
- [x] Media control interface (mute, codec switching)
- [x] Quality metrics reporting API
- [x] Event subscription model for asynchronous operations
- [x] Logging and tracing interfaces
- [x] Configuration management API
- [x] Transport abstraction for protocol flexibility
- [x] Helper functions for dialog operations:
  - [x] put_call_on_hold, resume_held_call
  - [x] verify_dialog_active, update_codec_preferences
  - [x] create_dialog_from_invite, send_dialog_request
  - [x] update_dialog_media, get_dialog_media_config

---

## ðŸ”„ PRIORITY 1: Media-Core Integration (Current Focus)

**Status**: This is the main gap that needs to be addressed to complete the session manager design.

### MediaManager Implementation 
- [ ] **Create MediaManager struct** to bridge session-core and media-core
  - [ ] Design MediaManager interface for RTP stream coordination
  - [ ] Implement session-to-media stream mapping
  - [ ] Add media stream lifecycle management (start/stop/pause)
  - [ ] Coordinate RTP stream setup based on SDP negotiation
  - [ ] Handle media stream cleanup on session termination

### RTP Stream Coordination
- [ ] **Extract RTP parameters** from negotiated SDP
- [ ] **Configure rtp-core streams** based on session requirements
- [ ] **Handle bidirectional RTP flow** (send/receive streams)
- [ ] **Coordinate RTCP reporting** with session state

### Media Event Integration
- [ ] **Subscribe to media-core events** (stream status, quality metrics)
- [ ] **Propagate media events** to session layer
- [ ] **Handle media failures** and recovery
- [ ] **Coordinate media-driven session state changes**

### Session-Media API Integration
- [ ] **Extend SessionManager** with media coordination
  - [ ] start_session_media(), stop_session_media(), update_session_media()
- [ ] **Extend Session** with media operations
  - [ ] media_status(), get_media_config(), update_media_config()
- [ ] **Update helper functions** to include media coordination
- [ ] **Add media events** to SessionEvent enum

---

## ðŸ”œ PRIORITY 2: Advanced Features

### Authentication Integration
- [ ] **Digest Authentication** implementation according to RFC 3261 Section 22.2
  - [ ] Challenge-response handling for 401/407 responses
  - [ ] Nonce tracking and expiration handling
  - [ ] Authentication caching for subsequent requests
  - [ ] Quality of protection (qop) support
- [ ] **High-level authentication API** for both client and server usage
- [ ] **Credential storage and management**

### Advanced Call Control
- [ ] **REFER handling** (RFC 3515) for call transfer
- [ ] **NOTIFY generation** for transfer progress updates
- [ ] **Attended transfer scenarios**
- [ ] **Replaces header support** (RFC 3891) for transfer completion

### Security Enhancements
- [ ] **TLS transport support integration** for secure signaling
- [ ] **SRTP coordination** for secure media (integrate with media-core)
- [ ] **Security event monitoring** and alerting

### Codec Negotiation Enhancement
- [ ] **Dynamic codec preference handling**
- [ ] **Codec capability discovery** from media-core
- [ ] **Advanced codec parameter negotiation**
- [ ] **Fallback codec selection**

---

## ðŸ”œ PRIORITY 3: Production Features

### Performance and Scalability
- [ ] **Session pooling** for high-volume environments
- [ ] **Connection reuse optimizations**
- [ ] **Memory usage optimization** for large session counts
- [ ] **Adaptive throttling mechanisms**
- [ ] **Distributed session management support**

### Advanced Media Features
- [ ] **Video stream coordination** (future)
- [ ] **Text stream support** (future)
- [ ] **ICE integration** for NAT traversal (RFC 8445)
- [ ] **RTCP feedback mechanisms** (RFC 4585)
- [ ] **DTMF handling** via RTP events (RFC 4733)

### Event System Enhancement
- [ ] **Type-safe event definitions** for all session activities
- [ ] **Event correlation and tracing** across layers
- [ ] **Event filtering and subscription management**
- [ ] **Event persistence** for debugging and analytics
- [ ] **Webhook support** for session events
- [ ] **WebSocket event streaming**
- [ ] **Event bus integration** with infra-common

### Monitoring and Observability
- [ ] **Call quality metrics collection**
- [ ] **Session duration and success rate tracking**
- [ ] **Performance monitoring integration**
- [ ] **Distributed tracing support**

---

## âœ… COMPLETED - Testing & Compliance

### Core Testing Infrastructure
- [x] Comprehensive test suite for transaction-to-session integration
- [x] Dialog creation and management tests
- [x] Session state transitions based on transaction events tests
- [x] Integration with transaction-core using mock transport
- [x] RFC-mandated behaviors test coverage
- [x] Critical performance metrics benchmarks

### Performance Testing
- [x] Benchmarks specific to async runtime performance
- [x] Resource usage reporting implementation
- [x] Metrics collection for operational monitoring

---

## ðŸ”œ TODO: Additional Testing & Integration

### Media Integration Testing
- [ ] **Unit tests** for MediaManager interface
- [ ] **Integration tests** for session+media flows
- [ ] **End-to-end session creation** with media setup
- [ ] **Session termination** with media cleanup
- [ ] **Hold/resume operations** with media direction changes

### Production Testing
- [ ] **Interoperability tests** with common SIP servers
- [ ] **Continuous performance regression testing**
- [ ] **High-volume session creation** with media
- [ ] **Memory usage** with large session counts
- [ ] **Event throughput** under load

---

## Recent Major Improvements âœ…

### Network Transport & Dialog Management
- [x] Transport trait abstraction for network operations
- [x] UDP transport with send/receive capabilities
- [x] Automatic address resolution for SIP URIs
- [x] INVITE client and server transaction state machines
- [x] Non-INVITE transaction support
- [x] Transaction manager for handling all transactions
- [x] Timer support for retransmissions
- [x] Reliable provisional responses (PRACK support)
- [x] Dialog creation from 2xx responses
- [x] Dialog state management and ID generation
- [x] Route set manipulation and early dialog support
- [x] Dialog-based request creation and in-dialog ACK generation
- [x] re-INVITE support for dialog refresh
- [x] UPDATE method support (RFC 3311)

### Session & SDP Handling
- [x] Basic SDP parsing and generation with sip-core integration
- [x] Audio codec support and proper SDP negotiation
- [x] SDP offer/answer model implementation
- [x] SDP version handling and early media SDP support
- [x] SDP renegotiation for session updates
- [x] Session refreshes with SDP and UPDATE method support

---

## Integration Notes

### Current Architecture Status
The session-core crate has a **very strong foundation** with:
- âœ… **Complete session management infrastructure**
- âœ… **Full SIP dialog handling with transaction integration**
- âœ… **Complete SDP negotiation framework**
- âœ… **Robust error handling and recovery mechanisms**
- âœ… **Production-ready async runtime optimizations**
- âœ… **Comprehensive public API with helper functions**

### Primary Gap: Media Integration
The **only major missing piece** is the MediaManager implementation to bridge session-core with media-core/rtp-core. This is outlined in **Priority 1** above and detailed in the INTEGRATION_PLAN.md.

### Next Steps
1. **Complete MediaManager implementation** (Priority 1)
2. **Add authentication integration** (Priority 2) 
3. **Enhance with advanced features** (Priority 3)

The session-core is well-positioned to serve as the **central coordination layer** once the media integration is completed. 