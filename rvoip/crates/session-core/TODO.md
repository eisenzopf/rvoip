# Session Core - TODO List

This document tracks planned improvements and enhancements for the `rvoip-session-core` library.

## Critical Integration Tasks

### 1. Transaction-Core Integration
- [x] Implement transaction event subscription in SessionManager
- [x] Create dedicated event processing loop for transaction events
- [x] Map transaction events to the correct dialog/session
- [x] Implement proper error handling for transaction failures
- [x] Add support for transaction state timeouts
- [x] Enhance the transaction_to_dialog mapping in DialogManager
- [x] Implement transaction cancellation for INVITE requests
- [x] Handle special cases like forked INVITE transactions
- [x] Implement proper transaction termination cleanup
- [x] Add retransmission handling coordination with transaction layer
- [x] Ensure proper ACK handling for non-2xx responses (auto-generated by transaction layer)
- [x] Add proper handling for transaction timer events (Timer A-K)
- [ ] Implement transaction recovery mechanisms for network failures
- [x] Sync transaction states with session/dialog states
- [ ] Add comprehensive logging for transaction events

### 2. Session State Management
- [x] Improve state transitions based on transaction events
- [x] Handle transaction failures in session state machine
- [ ] Add support for re-INVITEs and session refreshes
- [x] Implement proper dialog termination via BYE transactions
- [ ] Add support for handling authentication challenges
- [x] Handle INVITE transaction transitions to dialog states per RFC 3261 Section 13
- [x] Implement proper early dialog management with multiple transactions
- [ ] Add special handling for UPDATE method (RFC 3311)
- [x] Implement proper CANCEL handling as described in RFC 3261 Section 9
- [x] Add full support for multi-device forking scenarios

### 3. Request Generation and Processing
- [x] Enhance request generation for all SIP methods
- [x] Implement proper header generation (Via, Contact, etc.)
- [x] Add support for handling incoming requests via transactions
- [x] Improve response creation and sending through transactions
- [x] Implement proper ACK handling for INVITE transactions
- [x] Add correct handling of ACK for 2xx responses (TU responsibility)
- [x] Implement proper response handling for different transaction types
- [ ] Add tag generation and management for dialogs
- [ ] Implement correct CSeq handling for transactions
- [ ] Handle route set processing for dialogs
- [ ] Add automatic Route/Record-Route header handling

### 4. Error Handling & Robustness
- [x] Replace generic anyhow errors with specific error types
- [x] Implement detailed error categorization (network, protocol, application)
- [x] Add retry mechanisms for recoverable errors
- [x] Implement error propagation with context through the stack
- [x] Add graceful fallback for non-critical failures
- [x] Implement timeout handling for all operations
- [x] Add boundary checking for user inputs
- [ ] Implement circuit breakers for external systems
- [ ] Add panic recovery in critical paths
- [x] Create comprehensive error documentation for API users

## Next Steps (Short Term)

Before proceeding to other enhancements, the following issues need to be addressed:

1. **Fix remaining compilation errors**
   - [x] Address import/usage issues with ContentTypeValue
   - [x] Fix Bytes vs Vec<u8> conversion issues
   - [x] Ensure proper API usage with transaction-core
   - [x] Fix Uri and Host related errors
   - [x] Clean up duplicate code

2. **Documentation & Examples**
   - [x] Complete the basic_integration.rs example
   - [x] Add comments to explain integration patterns
   - [x] Document SessionManager and DialogManager integration with transaction-core
   - [x] Create API user guide for client and server implementations
   - [x] Document common error scenarios and handling approaches

3. **Testing**
   - [x] Create unit tests for transaction event handling
   - [x] Add integration tests for session-to-transaction coordination
   - [x] Test various error scenarios and recovery
   - [x] Implement load and performance benchmarks
   - [ ] Add soak testing for memory leaks detection
   - [x] Create test scenarios for concurrent session handling

## Existing Priority Improvements

### 5. Early Dialog Management
- [x] Enhance support for multiple simultaneous early dialogs
- [x] Implement forking scenario handling per RFC 3261 Section 12.1.2
- [ ] Add proper PRACK support for reliable provisional responses (RFC 3262)
- [ ] Improve handling of dialog matching for requests with multiple candidates
- [ ] Add proper dialog recovery after network failures

### 6. SDP Negotiation
- [x] Integrate SDP processing with transaction flow
- [x] Handle SDP offer/answer model correctly (RFC 3264)
- [x] Process SDP in responses and update media streams accordingly
- [ ] Add support for mid-call media updates
- [ ] Add support for media capability negotiation (RFC 5939)
- [ ] Implement bandwidth modifiers handling
- [ ] Add ICE candidates support (RFC 8445) for NAT traversal
- [ ] Support RTCP feedback mechanisms (RFC 4585)

### 7. Security Features
- [ ] Implement Digest Authentication (RFC 3261 Section 22.2)
- [ ] Add support for TLS transport in dialogs
- [ ] Integrate SRTP for secure media (RFC 3711)
- [ ] Support Identity header for call verification (RFC 8224)
- [ ] Implement SIPS URI scheme handling

## Additional Enhancements

### 8. Performance and Scalability
- [ ] Implement session pooling for high-volume environments
- [ ] Add connection reuse optimizations
- [x] Create comprehensive benchmarking suite
- [ ] Optimize memory usage for large session counts
- [x] Add configurable limits for resource management
- [ ] Implement adaptive throttling mechanisms
- [ ] Create performance profiling tools
- [ ] Support for distributed session management
- [x] Add metrics collection for operational monitoring
- [x] Implement resource usage reporting

### 9. Public API Enhancements
- [x] Create high-level client API for common call scenarios
- [x] Add server API for registration, proxy, and B2BUA use cases
- [x] Implement session modification API (hold, resume, transfer)
- [x] Add media control interface (mute, codec switching)
- [ ] Create high-level authentication handling
- [x] Add quality metrics reporting API
- [x] Implement event subscription model for asynchronous operations
- [x] Create logging and tracing interfaces
- [x] Add configuration management API
- [x] Create transport abstraction for protocol flexibility

### 10. Call Transfer Features
- [ ] Complete implementation of REFER handling (RFC 3515)
- [ ] Add NOTIFY generation for transfer progress updates
- [ ] Implement attended transfer scenarios
- [ ] Support Replaces header (RFC 3891) for transfer completion

### 11. Advanced Dialog Features
- [ ] Implement dialog refreshing mechanism
- [ ] Add support for dialog recovery from network failures
- [x] Enhance Route header management for complex topologies
- [ ] Support Path header for registration scenarios (RFC 3327)

### 12. Testing & Compliance
- [x] Create test suite for transaction-to-session integration
- [x] Test dialog creation and management
- [x] Test session state transitions based on transaction events
- [x] Test integration with transaction-core using mock transport
- [x] Add comprehensive test suite for all RFC-mandated behaviors
- [ ] Create interoperability tests with common SIP servers
- [x] Document compliance status for each section of relevant RFCs
- [x] Add benchmarks for critical performance metrics
- [ ] Implement continuous performance regression testing

### 13. Documentation
- [x] Document transaction-to-session integration patterns
- [x] Add detailed API documentation with examples
- [x] Create sequence diagrams for common call flows
- [x] Document integration patterns with client and server applications
- [x] Add troubleshooting guide for common issues
- [x] Create operational best practices guide

## Recent Improvements (May 2025)

### Code Structure and Organization
- [x] Moved monitoring code from lib.rs into a dedicated metrics.rs module
- [x] Created comprehensive helper functions for dialog management in helpers.rs
- [x] Improved error handling with categorized errors and recovery suggestions
- [x] Added integration between the error system and the dialog/session modules
- [x] Re-exported all necessary types for easier library usage

### API Improvements
- [x] Created helper functions for common operations: make_call, answer_call, end_call
- [x] Added dialog management helpers: create_dialog_from_invite, send_dialog_request, terminate_dialog
- [x] Improved error context information with more detailed metadata
- [x] Provided better error handling with recovery suggestions

### Examples and Testing
- [x] Updated all examples to use the helper functions instead of direct API calls
- [x] Improved the benchmarking example to handle 10,000 concurrent sessions
- [x] Added better dialog creation and management in the integrated_call example
- [x] Fixed compilation issues and type mismatches

## Future Considerations

### Advanced Media Features
- [ ] Support for video sessions
- [ ] Implementation of WebRTC integration
- [ ] Advanced audio processing capabilities
- [ ] Multi-party conferencing support

### Standards Extensions
- [ ] Support for SIP extensions (INFO, MESSAGE, etc.)
- [ ] Implementation of presence and events framework (RFC 3856, RFC 3265)
- [ ] Support for advanced SIP routing features
- [ ] Integration with IMS/VoLTE standards 